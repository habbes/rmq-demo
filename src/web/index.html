<!doctype html>
<html lang="en">
<head>
    <title>RabbitMQ Demo</title>
</head>
<body>
    <header>
        <h1>RabbitMQ Demo</h1>
    </header>

    <div class="main">
        <div class="left">
            <div class="client-details">
                <div>Client ID: <span id="clientId"></span></div>
                <div>Connected to: <span id="serverId"></span></div>
            </div>
            <div class="job-form">
                <h3>New Job</h3>
                <input id="newJobData" type="text" placeholder="Enter text input">
                <button id="newJobBtn">Submit Job</button> 
            </div>
        </div>
        <div class="right">
            <h4>Job Results</h4>
        </div>
    </div>
    
    <footer>
        <a href="https://github.com/habbes/rmq-demo">Documentation and Source Code</a>
    </footer>
<script>

var clientId, serverId, socket;

init();

function init () {
    setClientId();
    connectSocket();
    sendIdMessage();
    setMessageHandler();
}

/**
 * generates and assigns clientId
 */
function setClientId () {
    clientId = generateClientId();
    document.querySelector("#clientId").textContent = clientId;
}

/**
 * establish websocket connection to server
 */
function connectSocket () {
    socket = new WebSocket(getSocketUrl());
}

/**
 * send id message to identify self to server
 * this is the first message sent to server, right
 * after socket connection is open
 */
function sendIdMessage () {
    socket.onopen = function () {
        var msg = buildIdMessage(clientId);
        sendMessage(msg);
    };
}

/**
 * sets up the websocket message handler
 * assigning handlers to messages based on their
 * type
 */
function setMessageHandler () {
    socket.onmessage = function (e) {
        var msg = JSON.parse(e.data);
        switch (msg.type) {
            case 'id':
                return handleIdMessage(msg);
            default:
                console.warn("Unhandled message:", msg);
        }
    };
}

/**
 * send a message to the server
 * @param {Object} msg
 */
function sendMessage (msg) {
    socket.send(JSON.stringify(msg));
}

/**
 * constructs and ID message
 * used to identify the client to the server
 * @param {String} id client id
 * @return {Object}
 */
function buildIdMessage (id) {
    return {
        type: 'id',
        clientId: id
    };
}

// MESSAGE HANDLERS

function handleIdMessage (msg) {
    serverId = msg.serverId;
    document.querySelector("#serverId").textContent = serverId;
}

/**
 * generates a random id to be assigned to the client app
 * @return {String}
 */
function generateClientId () {
    return Math.random().toString(16).substr(2) + 
        Math.random().toString(16).substr(2);
}

/**
 * returns the websocket url to the connected
 * server based on the current url
 * @return {String}
 */
function getSocketUrl () {
    return window.location.href.replace('http', 'ws');
}

</script>    
</body>
</html>