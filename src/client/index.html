<!doctype html>
<html lang="en">
<head>
    <title>RabbitMQ Demo</title>
</head>
<body>
    <header>
        <h1>RabbitMQ Demo</h1>
    </header>

    <div class="main">
        <div class="left">
            <div class="client-details">
                <div>Client ID: <span id="clientId"></span></div>
                <div>Connected to: <span id="serverId"></span></div>
            </div>
            <div class="job-form">
                <h3>New Job</h3>
                <input id="newJobInput" type="text" placeholder="Enter text input">
                <button id="newJobBtn">Submit Job</button> 
            </div>
        </div>
        <div class="right">
            <h4>Job Results</h4>
        </div>
    </div>
    
    <footer>
        <a href="https://github.com/habbes/rmq-demo">Documentation and Source Code</a>
    </footer>
<script>

var newJobBtn = document.getElementById('newJobBtn');
var newJobInput = document.getElementById('newJobInput');

window.onload = init;

function init () {
    client = new Client(getSocketUrl());
    document.getElementById('clientId').textContent = client.id;
    client.onMessage = function (msg, c) {
        switch (msg.type) {
            case 'id':
                return handleIdMessage(msg, c);
            default:
                console.log('Unhandled message', msg);
        }
    };

    newJobBtn.addEventListener('click', function (e) {
        var input = newJobInput.value;
        client.sendJobMessage(input);
        newJobInput.value = '';
    });
}
// MESSAGE HANDLERS

function handleIdMessage (msg, cl) {
    document.getElementById('serverId').textContent = cl.serverId;
}

</script>
<script>
// CLIENT CLASS
class Client {
    constructor (url) {
        this.id = generateId();
        this.serverId = null;
        this.socket = new WebSocket(url);
        this.socket.onopen = this._onSockOpen.bind(this);
        this.socket.onmessage = this._onSockMessage.bind(this);
    }

    _onSockOpen () {
        this.sendIdMessage();
    }

    _onSockMessage (e) {
        const msg = JSON.parse(e.data);
        if (msg.type === 'id') {
            this.serverId = msg.serverId;
        }
        if (this.onMessage) {
            this.onMessage(msg, this);
        }
        else {
            console.warn('No message handler defined for client. Unhandled message:', msg);
        }
    }

    send (msg) {
        this.socket.send(JSON.stringify(msg));
    }

    sendIdMessage () {
        this.send({
            type: 'id',
            clientId: this.id
        });
    }

    sendJobMessage (input) {
        this.send({
            type: 'job',
            clientId: this.id,
            jobId: generateId(),
            input: input
        });
    }
}
</script> 
<script>
// HELPERS

/**
 * generates a random id to
 * @return {String}
 */
function generateId () {
    return Math.random().toString(16).substr(2) + 
        Math.random().toString(16).substr(2);
}

/**
 * returns the websocket url to the connected
 * server based on the current url
 * @return {String}
 */
function getSocketUrl () {
    return window.location.href.replace(/^http/, 'ws');
}
</script>
</body>
</html>